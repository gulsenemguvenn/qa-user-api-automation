name: API Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install mock dependencies
        working-directory: mock
        run: npm ci

      - name: Start mock server
        working-directory: mock
        run: |
          nohup npx json-server --watch db.json --port 3000 > json-server.log 2>&1 &
          sleep 2
          curl -sSf http://localhost:3000/users

      - name: Run API tests
        working-directory: automation
        run: mvn -q -Dapi.baseUrl=http://localhost:3000 test
